# StudX Crontab Configuration
# Автоматические задачи для сервера

# Мониторинг системы - каждые 5 минут
*/5 * * * * /var/www/studx/server-setup/monitor.sh >> /var/log/studx-monitor.log 2>&1

# Бэкап БД и файлов - каждую ночь в 3:00
0 3 * * * /var/www/studx/server-setup/backup.sh >> /var/log/studx-backup.log 2>&1

# Обновление SSL сертификата - каждый день в 4:00
0 4 * * * certbot renew --quiet --post-hook "systemctl reload nginx"

# Очистка старых логов - каждое воскресенье в 5:00
0 5 * * 0 find /var/log -type f -name "*.log" -mtime +30 -delete

# Очистка временных файлов - каждый день в 2:00
0 2 * * * find /tmp -type f -mtime +7 -delete

# Ротация логов PM2 - каждый день в 1:00
0 1 * * * pm2 flush >> /var/log/pm2-flush.log 2>&1

# Проверка места на диске - каждые 30 минут
*/30 * * * * df -h / | awk 'NR==2 {if(int($5) > 85) print "ALERT: Disk usage is "$5" on $(hostname)" | mail -s "Disk Alert" admin@studx.ru}'

# Перезапуск PM2 процессов при высоком потреблении памяти - каждый час
0 * * * * pm2 resurrect >> /var/log/pm2-resurrect.log 2>&1

# Синхронизация бэкапов с S3 (если настроено) - каждую ночь в 4:30
30 4 * * * [ ! -z "$BACKUP_S3_BUCKET" ] && aws s3 sync /var/backups/studx s3://$BACKUP_S3_BUCKET/studx-backups/ --delete >> /var/log/s3-sync.log 2>&1

# Отчет о состоянии системы на email - каждый понедельник в 9:00
0 9 * * 1 /var/www/studx/server-setup/check-system.sh | mail -s "StudX Weekly System Report" admin@studx.ru